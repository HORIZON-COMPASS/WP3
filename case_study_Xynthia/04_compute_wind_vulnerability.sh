#!/bin/bash
#SBATCH --qos=priority
#SBATCH --partition=priority
#SBATCH --job-name=aggregate_ERA_data
#SBATCH --account=isimip
#SBATCH --output=aggr-%j.out
#SBATCH --error=aggr-%j.err
#SBATCH --cpus-per-task=16

## Extract daily maxima and percentiles of wind speed
for g in {0..99}
do
	era5_ga="/p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined_detrended/sfcWind_detrended_ERA5_$g.nc"
	era5_gmax="/p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined_detrended/sfcWind_detrended_ERA5_daymax_$g.nc"
	era5_gpctl="/p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined_detrended/sfcWind_detrended_ERA5_pctl_$g.nc"
	cdo -f nc4c -z zip daymax $era5_ga $era5_gmax
	cdo timpctl,98 $era5_gmax -timmin $era5_gmax -timmax $era5_gmax $era5_gpctl
	era5_ga="/p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined/sfcWind_ERA5_$g.nc"
	era5_gmax="/p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined/sfcWind_ERA5_daymax_$g.nc"
	cdo -f nc4c -z zip daymax $era5_ga $era5_gmax
done

## combine wind files
cdo -z zip collgrid /p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined_detrended/sfcWind_detrended_ERA5_daymax_*.nc sfcWind_detrended_ERA5_daymax.nc
cdo -z zip collgrid /p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined_detrended/sfcWind_detrended_ERA5_pctl_*.nc sfcWind_detrended_ERA5_pctl.nc
cdo -z zip collgrid /p/tmp/dominikp/COMPASS/Meteo_data/Wind_combined/sfcWind_ERA5_daymax_*.nc sfcWind_ERA5_daymax.nc
cdo -z zip selmonth,2,3 -selyear,2010 sfcWind_ERA5_daymax.nc sfcWind_ERA5_daymax_Xynthia.nc
cdo -z zip selmonth,2,3 -selyear,2010 sfcWind_detrended_ERA5_daymax.nc sfcWind_ERA5_detrended_daymax_Xynthia.nc

## compute wind damage fractions with Klawa and Ulbrich (2003) damage function
cdo -z zip yearmax -selday,26,27,28 -selmonth,2 -shifttime,-1days sfcWind_ERA5_daymax_Xynthia.nc Damage/factual_daymax_Xynthia.nc
cdo -z zip yearmax -selday,26,27,28 -selmonth,2 -shifttime,-1days sfcWind_ERA5_detrended_daymax_Xynthia.nc Damage/counterfactual_daymax_Xynthia.nc
cdo -z zip div Damage/factual_daymax_Xynthia.nc sfcWind_detrended_ERA5_pctl.nc Damage/factual_max_ratio_Xynthia.nc
cdo -z zip div Damage/counterfactual_daymax_Xynthia.nc sfcWind_detrended_ERA5_pctl.nc Damage/counterfactual_max_ratio_Xynthia.nc
cdo -z zip expr,vuln="(sfcWind-1)^3" Damage/factual_max_ratio_Xynthia.nc Damage/factual_vuln_Xynthia.nc
cdo -z zip expr,vuln="(sfcWind-1)^3" Damage/counterfactual_max_ratio_Xynthia.nc Damage/counterfactual_vuln_Xynthia.nc